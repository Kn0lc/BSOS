#define IDT_FLAG_INTERRUPT_GATE 0xe
#define IDT_FLAG_PRESENT 0x80
#define IDT_FLAG_RING0 0x00
#define IDT_FLAG_RING3 0x60
#define IDT_ENTRIES 256

#include <stdint.h>
#include "IDT.h"
#include "init.h"
#include "Meldungen.h"
#include "TextMode.h"


uint32_t FehlerMeldungasm0(void);
uint32_t FehlerMeldungasm1(void);
uint32_t FehlerMeldungasm2();
uint32_t FehlerMeldungasm3(void);
uint32_t FehlerMeldungasm4(void);
uint32_t FehlerMeldungasm5(void);
uint32_t FehlerMeldungasm6(void);
uint32_t FehlerMeldungasm7(void);
uint32_t FehlerMeldungasm8(void);
uint32_t FehlerMeldungasm9(void);
uint32_t FehlerMeldungasm10(void);
uint32_t FehlerMeldungasm11(void);
uint32_t FehlerMeldungasm12(void);
uint32_t FehlerMeldungasm13(void);
uint32_t FehlerMeldungasm14(void);
uint32_t FehlerMeldungasm15(void);
uint32_t FehlerMeldungasm16(void);
uint32_t FehlerMeldungasm17(void);
uint32_t FehlerMeldungasm18(void);
uint32_t FehlerMeldungasm19(void);

uint32_t HardwareMeldungasm0(void);
uint32_t HardwareMeldungasm1(void);
uint32_t HardwareMeldungasm2(void);
uint32_t HardwareMeldungasm3(void);
uint32_t HardwareMeldungasm4(void);
uint32_t HardwareMeldungasm5(void);
uint32_t HardwareMeldungasm6(void);
uint32_t HardwareMeldungasm7(void);
uint32_t HardwareMeldungasm8(void);
uint32_t HardwareMeldungasm9(void);
uint32_t HardwareMeldungasm10(void);
uint32_t HardwareMeldungasm11(void);
uint32_t HardwareMeldungasm12(void);
uint32_t HardwareMeldungasm13(void);
uint32_t HardwareMeldungasm14(void);
uint32_t HardwareMeldungasm15(void);

uint32_t SoftwareMeldungasm0(void);


static uint64_t idt[IDT_ENTRIES];

static inline void outb(uint16_t port, uint8_t data)
{
    asm volatile ("outb %0, %1" : : "a" (data), "Nd" (port));
}

static void init_pic(void)
{
// Master-PIC initialisieren
    outb(0x20, 0x11); // Initialisierungsbefehl fuer den PIC
    outb(0x21, 0x20); // Interruptnummer fuer IRQ 0
    outb(0x21, 0x04); // An IRQ 2 haengt der Slave
    outb(0x21, 0x01); // ICW 4

// Slave-PIC initialisieren
    outb(0xa0, 0x11); // Initialisierungsbefehl fuer den PIC
    outb(0xa1, 0x28); // Interruptnummer fuer IRQ 8
    outb(0xa1, 0x02); // An IRQ 2 haengt der Slave
    outb(0xa1, 0x01); // ICW 4

// Alle IRQs aktivieren (demaskieren)
    outb(0x20, 0x0);
    outb(0xa0, 0x0);
}
static void idt_set_entry(int i, uint32_t (*fn)(), unsigned int selector, int flags)
{
    unsigned long int handler = (unsigned long int) fn;
    idt[i] = handler & 0xffffLL;
    idt[i] |= (selector & 0xffffLL) << 16;
    idt[i] |= (flags & 0xffLL) << 40;
    idt[i] |= ((handler>> 16) & 0xffffLL) << 48;
}

void load_idt(void);


struct cpu_state
{
// Von Hand gesicherte Register
    uint32_t eax;
    uint32_t ebx;
    uint32_t ecx;
    uint32_t edx;
    uint32_t esi;
    uint32_t edi;
    uint32_t ebp;

    uint32_t intr;
    uint32_t error;

// Von der CPU gesichert
    uint32_t eip;
    uint32_t cs;
    uint32_t eflags;
    uint32_t esp;
    uint32_t ss;
};

void load_idt(void)
{

    struct
    {
        uint16_t limit;
        void* pointer;
    } __attribute__((packed)) idtp =
    {
        .limit = IDT_ENTRIES * 8 - 1,
        .pointer = idt,
    };

// Interruptnummern der IRQs umbiegen
    init_pic();


// Excpetion-Handler
    idt_set_entry(0, FehlerMeldungasm0, 0x8, IDT_FLAG_INTERRUPT_GATE | IDT_FLAG_RING0 | IDT_FLAG_PRESENT);
    idt_set_entry(1, FehlerMeldungasm1, 0x8, IDT_FLAG_INTERRUPT_GATE | IDT_FLAG_RING0 | IDT_FLAG_PRESENT);
    idt_set_entry(2, FehlerMeldungasm2, 0x8, IDT_FLAG_INTERRUPT_GATE | IDT_FLAG_RING0 | IDT_FLAG_PRESENT);
    idt_set_entry(3, FehlerMeldungasm3, 0x8, IDT_FLAG_INTERRUPT_GATE | IDT_FLAG_RING0 | IDT_FLAG_PRESENT);
    idt_set_entry(4, FehlerMeldungasm4, 0x8, IDT_FLAG_INTERRUPT_GATE | IDT_FLAG_RING0 | IDT_FLAG_PRESENT);
    idt_set_entry(5, FehlerMeldungasm5, 0x8, IDT_FLAG_INTERRUPT_GATE | IDT_FLAG_RING0 | IDT_FLAG_PRESENT);
    idt_set_entry(6, FehlerMeldungasm6, 0x8, IDT_FLAG_INTERRUPT_GATE | IDT_FLAG_RING0 | IDT_FLAG_PRESENT);
    idt_set_entry(7, FehlerMeldungasm7, 0x8, IDT_FLAG_INTERRUPT_GATE | IDT_FLAG_RING0 | IDT_FLAG_PRESENT);
    idt_set_entry(8, FehlerMeldungasm8, 0x8, IDT_FLAG_INTERRUPT_GATE | IDT_FLAG_RING0 | IDT_FLAG_PRESENT);
    idt_set_entry(9, FehlerMeldungasm9, 0x8, IDT_FLAG_INTERRUPT_GATE | IDT_FLAG_RING0 | IDT_FLAG_PRESENT);
    idt_set_entry(10, FehlerMeldungasm10, 0x8, IDT_FLAG_INTERRUPT_GATE | IDT_FLAG_RING0 | IDT_FLAG_PRESENT);
    idt_set_entry(11, FehlerMeldungasm11, 0x8, IDT_FLAG_INTERRUPT_GATE | IDT_FLAG_RING0 | IDT_FLAG_PRESENT);
    idt_set_entry(12, FehlerMeldungasm12, 0x8, IDT_FLAG_INTERRUPT_GATE | IDT_FLAG_RING0 | IDT_FLAG_PRESENT);
    idt_set_entry(13, FehlerMeldungasm13, 0x8, IDT_FLAG_INTERRUPT_GATE | IDT_FLAG_RING0 | IDT_FLAG_PRESENT);
    idt_set_entry(14, FehlerMeldungasm14, 0x8, IDT_FLAG_INTERRUPT_GATE | IDT_FLAG_RING0 | IDT_FLAG_PRESENT);
    idt_set_entry(15, FehlerMeldungasm15, 0x8, IDT_FLAG_INTERRUPT_GATE | IDT_FLAG_RING0 | IDT_FLAG_PRESENT);
    idt_set_entry(16, FehlerMeldungasm16, 0x8, IDT_FLAG_INTERRUPT_GATE | IDT_FLAG_RING0 | IDT_FLAG_PRESENT);
    idt_set_entry(17, FehlerMeldungasm17, 0x8, IDT_FLAG_INTERRUPT_GATE | IDT_FLAG_RING0 | IDT_FLAG_PRESENT);
    idt_set_entry(18, FehlerMeldungasm18, 0x8, IDT_FLAG_INTERRUPT_GATE | IDT_FLAG_RING0 | IDT_FLAG_PRESENT);
    idt_set_entry(19, FehlerMeldungasm19, 0x8, IDT_FLAG_INTERRUPT_GATE | IDT_FLAG_RING0 | IDT_FLAG_PRESENT);
// IRQ-Handler
    idt_set_entry(32, HardwareMeldungasm0, 0x8, IDT_FLAG_INTERRUPT_GATE | IDT_FLAG_RING0 | IDT_FLAG_PRESENT);
    idt_set_entry(33, HardwareMeldungasm1, 0x8, IDT_FLAG_INTERRUPT_GATE | IDT_FLAG_RING0 | IDT_FLAG_PRESENT);
    idt_set_entry(34, HardwareMeldungasm2, 0x8, IDT_FLAG_INTERRUPT_GATE | IDT_FLAG_RING0 | IDT_FLAG_PRESENT);
    idt_set_entry(35, HardwareMeldungasm3, 0x8, IDT_FLAG_INTERRUPT_GATE | IDT_FLAG_RING0 | IDT_FLAG_PRESENT);
    idt_set_entry(36, HardwareMeldungasm4, 0x8, IDT_FLAG_INTERRUPT_GATE | IDT_FLAG_RING0 | IDT_FLAG_PRESENT);
    idt_set_entry(37, HardwareMeldungasm5, 0x8, IDT_FLAG_INTERRUPT_GATE | IDT_FLAG_RING0 | IDT_FLAG_PRESENT);
    idt_set_entry(38, HardwareMeldungasm6, 0x8, IDT_FLAG_INTERRUPT_GATE | IDT_FLAG_RING0 | IDT_FLAG_PRESENT);
    idt_set_entry(39, HardwareMeldungasm7, 0x8, IDT_FLAG_INTERRUPT_GATE | IDT_FLAG_RING0 | IDT_FLAG_PRESENT);
    idt_set_entry(40, HardwareMeldungasm8, 0x8, IDT_FLAG_INTERRUPT_GATE | IDT_FLAG_RING0 | IDT_FLAG_PRESENT);
    idt_set_entry(41, HardwareMeldungasm9, 0x8, IDT_FLAG_INTERRUPT_GATE | IDT_FLAG_RING0 | IDT_FLAG_PRESENT);
    idt_set_entry(42, HardwareMeldungasm10, 0x8, IDT_FLAG_INTERRUPT_GATE | IDT_FLAG_RING0 | IDT_FLAG_PRESENT);
    idt_set_entry(43, HardwareMeldungasm11, 0x8, IDT_FLAG_INTERRUPT_GATE | IDT_FLAG_RING0 | IDT_FLAG_PRESENT);
    idt_set_entry(44, HardwareMeldungasm12, 0x8, IDT_FLAG_INTERRUPT_GATE | IDT_FLAG_RING0 | IDT_FLAG_PRESENT);
    idt_set_entry(45, HardwareMeldungasm13, 0x8, IDT_FLAG_INTERRUPT_GATE | IDT_FLAG_RING0 | IDT_FLAG_PRESENT);
    idt_set_entry(46, HardwareMeldungasm14, 0x8, IDT_FLAG_INTERRUPT_GATE | IDT_FLAG_RING0 | IDT_FLAG_PRESENT);
    idt_set_entry(47, HardwareMeldungasm15, 0x8, IDT_FLAG_INTERRUPT_GATE | IDT_FLAG_RING0 | IDT_FLAG_PRESENT);
// Syscall
    idt_set_entry(48, SoftwareMeldung0, 0x8, IDT_FLAG_INTERRUPT_GATE | IDT_FLAG_RING3 | IDT_FLAG_PRESENT);
    asm volatile("lidt %0" : : "m" (idtp));

    asm volatile("sti");
}
